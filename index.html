<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel</title>
<style>
  :root { --bg-main: #0f1724; --bg-section: #0b1220; --border-color: #1f2937; --text-main: #e6eef8; --text-muted: #9fb3d9; --green: #16a34a; --red: #dc2626; --blue: #2563eb; --yellow: #f59e0b; --purple: #4f46e5; }
  body{margin:0;padding:20px;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg-main);color:var(--text-main); display: flex; align-items: center; justify-content: center; min-height: 100vh;}
  .container{max-width:1300px;margin:0 auto; width: 100%;}
  h1,h2{margin:0 0 12px 0; text-align: center;}
  .section{background:var(--bg-section);border:1px solid var(--border-color);border-radius:10px;padding:12px;margin-bottom:16px;}
  table{width:100%;border-collapse:collapse;margin-top:8px;}
  th,td{padding:8px 10px;border:1px solid rgba(255,255,255,0.06);text-align:center;font-size:14px; word-break: break-word; vertical-align: middle;}
  th{background:rgba(255,255,255,0.03);}
  tr.clickable { cursor: pointer; } tr.clickable:hover { background-color: rgba(255,255,255,0.04); }
  .no-data{opacity:0.7;text-align:center;padding:18px;color:var(--text-muted);}
  #login-container { text-align: center; padding-top: 20vh;}
  #adminLoginBtn { background: #4285F4; color: white; border: none; padding: 12px 24px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; font-weight: 600; }
  .btn { padding: 5px 10px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.8rem; margin: 2px; }
  .btn-green { background: var(--green); } .btn-red { background: var(--red); } .btn-blue { background: var(--blue); } .btn-dark-red { background: #991b1b; } .btn-yellow { background: var(--yellow); }
  .status { font-weight: bold; padding: 4px 8px; border-radius: 6px; color: white; }
  .status-pending { background-color: var(--yellow); } .status-approved { background-color: var(--green); } .status-rejected { background-color: var(--red); }
  .actions-cell { display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap; }
  #userSearchInput { width: 100%; padding: 8px 12px; margin-bottom: 12px; background-color: #1e293b; border: 1px solid #334155; border-radius: 6px; color: var(--text-main); font-size: 1rem; box-sizing: border-box; }
  #dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .stat-card { background: var(--bg-section); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px; text-align: center; }
  .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; color: var(--text-main); }
  .stat-label { font-size: 0.9rem; color: var(--text-muted); }
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
  .modal-content { background: var(--bg-main); border: 1px solid var(--border-color); width: min(90vw, 900px); max-height: 90vh; display: flex; flex-direction: column; border-radius: 12px; }
  .modal-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .modal-header h3 { margin: 0; }
  .modal-close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
  .modal-body { padding: 16px; overflow-y: auto; }
  .modal-grid { display: grid; grid-template-columns: 300px 1fr; gap: 16px; }
  .user-info-panel .info-item { margin-bottom: 10px; font-size: 0.9rem; }
  .user-info-panel .info-item strong { color: var(--text-muted); display: block; margin-bottom: 4px; }
  .user-actions { border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; }
  .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 12px; }
  .tab-btn { background: none; border: none; color: var(--text-muted); padding: 10px 15px; cursor: pointer; font-size: 1rem; border-bottom: 2px solid transparent; }
  .tab-btn.active { color: var(--text-main); border-bottom-color: var(--blue); }
  .tab-content { display: none; } .tab-content.active { display: block; }
  #modal-chat-container { height: 400px; display: flex; flex-direction: column; }
  #modal-messages { flex-grow: 1; overflow-y: auto; padding: 5px; background: var(--bg-section); border-radius: 8px; }
  #modal-reply-area { display: flex; margin-top: 10px; }
  .balance-input { width: 80px; padding: 4px; border-radius: 4px; border: 1px solid #334155; background: #1e293b; color: var(--text-main); }
  #announcement-textarea { width: 100%; box-sizing: border-box; background: #1e293b; border: 1px solid #334155; color: var(--text-main); padding: 10px; border-radius: 6px; min-height: 80px; margin-bottom: 10px; }
  #past-announcements-list { max-height: 200px; overflow-y: auto; margin-top: 12px; }
  .past-announcement-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start; }
  .past-announcement-item p { margin: 0; white-space: pre-wrap; word-break: break-word; }
  .past-announcement-item .meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; }
  .message { max-width: 70%; padding: 8px 12px; border-radius: 10px; line-height: 1.4; word-break: break-word; }
  .message.user { background: #374151; color: white; align-self: flex-start; }
  .message.admin { background: var(--purple); color: white; align-self: flex-end; }
  
  @media screen and (max-width: 768px) {
    body { padding: 10px; }
    .modal-grid { grid-template-columns: 1fr; }
    table, thead, tbody, th, td, tr { display: block; }
    thead tr { position: absolute; top: -9999px; left: -9999px; }
    tr { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    td { border: none; border-bottom: 1px solid rgba(255,255,255,0.06); position: relative; padding-left: 50%; text-align: right; min-height: 30px; display: flex; align-items: center; justify-content: flex-end; }
    td:last-child { border-bottom: 0; }
    td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; opacity: 0.8; }
  }
</style>
</head>
<body>
<div class="container">
    <div id="login-container"><h1>Admin Panel</h1><button id="adminLoginBtn">Google ilə Daxil Ol</button></div>
    <div id="main-content" style="display: none;">
        <h1 id="admin-welcome"></h1>
        <div id="dashboard-grid" class="section">
            <div class="stat-card"><div class="stat-value" id="stat-total-users">0</div><div class="stat-label">Ümumi İstifadəçi</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-total-balance">0.00</div><div class="stat-label">Sistemdəki Balans (AZN)</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-pending-reqs">0</div><div class="stat-label">Gözləyən Sorğu</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-pending-amount">0.00</div><div class="stat-label">Gözləyən Məbləğ (AZN)</div></div>
            <div class="stat-card"><div class="stat-value" id="stat-unread-msgs">0</div><div class="stat-label">Oxunmamış Mesaj</div></div>
        </div>
        <div class="section">
            <h2 style="margin:0;">Ümumi Elan Göndər</h2>
            <textarea id="announcement-textarea" placeholder="Bütün istifadəçilərə göndəriləcək mesajı bura yazın..."></textarea>
            <button id="sendAnnouncementBtn" class="btn btn-purple">Elanı Göndər</button>
            <div id="past-announcements-list"></div>
        </div>
        <div class="section">
            <h2 style="margin:0;">Pul Çıxarma Sorğuları</h2>
            <table id="withdrawalsTable"><thead><tr><th>Email</th><th>Ad/Soyad</th><th>Kart</th><th>Məbləğ</th><th>Tarix</th><th>Status</th><th>Əməliyyat</th></tr></thead><tbody><tr class="no-data-row"><td colspan="7" class="no-data">Heç bir sorğu yoxdur.</td></tr></tbody></table>
        </div>
        <div class="section">
            <h2 style="margin:0;">İstifadəçilər & Balans</h2>
            <input type="search" id="userSearchInput" placeholder="Ada və ya emailə görə axtar...">
            <table id="userTable"><thead><tr><th>Ad</th><th>Email</th><th>Balans (AZN)</th><th>Status</th></tr></thead><tbody><tr class="no-data-row"><td colspan="4" class="no-data">İstifadəçi yoxdur.</td></tr></tbody></table>
        </div>
    </div>
</div>

<div id="userDetailsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalUserName"></h3>
            <button class="modal-close-btn" onclick="closeUserDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-grid">
                <div class="user-info-panel">
                    <div class="section">
                        <div class="info-item"><strong>Email:</strong> <span id="modalUserEmail"></span></div>
                        <div class="info-item"><strong>UID:</strong> <span id="modalUserUID"></span></div>
                        <div class="info-item"><strong>Balans:</strong> <span id="modalUserBalance" style="font-weight:bold; font-size:1.2rem;"></span></div>
                    </div>
                    <div class="section">
                        <h4 style="margin-top:0;">Balans Artır</h4>
                        <div class="actions-cell" style="flex-direction:column; align-items:stretch; gap:8px;">
                            <input type="text" id="modal-balance-input" placeholder="+50, -20, 200" class="balance-input" style="width:100%;">
                            <button class="btn btn-blue" id="modal-apply-balance-btn">Tətbiq et</button>
                        </div>
                    </div>
                    <div class="section user-actions">
                        <h4 style="margin-top:0;">Hesab Statusu</h4>
                        <div class="info-item"><strong>Status:</strong> <span id="modalUserStatus"></span></div>
                        <div class="actions-cell" style="flex-direction:column; align-items:stretch; gap:8px;">
                            <button class="btn btn-yellow" id="modal-suspend-btn">Hesabı Dondur</button>
                            <button class="btn btn-green" id="modal-reactivate-btn">Hesabı Aktivləşdir</button>
                        </div>
                    </div>
                </div>
                <div class="user-details-panel">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="transactions">Əməliyyatlar</button>
                        <button class="tab-btn" data-tab="chat">Dəstək Yazışmaları</button>
                    </div>
                    <div id="tab-content-transactions" class="tab-content active">
                        <div id="modal-transactions-list" style="max-height: 400px; overflow-y:auto; padding:5px;"></div>
                    </div>
                    <div id="tab-content-chat" class="tab-content">
                        <div id="modal-chat-container">
                            <div id="modal-messages" class="messages"></div>
                            <div id="modal-reply-area" class="reply-area">
                                <input type="text" id="modal-reply-input" placeholder="Cavabınızı yazın..." style="flex-grow:1; background:#1e293b; border:1px solid #334155; border-radius:6px; padding:8px; color:white;">
                                <button id="modal-send-reply-btn" class="btn btn-purple" style="margin-left:8px;">Göndər</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw", authDomain: "niceuc-e5986.firebaseapp.com", databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com", projectId: "niceuc-e5986", appId: "1:242221260650:web:d140153a2167c4738dcf13" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentChatUid = null;
    let messagesListener = null;
    let masterUserList = [];
    let modalMessagesListener = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('admin-welcome').textContent = `Xoş gəldiniz, ${user.displayName}`;
            loadAllData();
        } else {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';
        }
    });

    document.getElementById('adminLoginBtn').addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));
    
    function loadAllData() {
        loadDashboardStats();
        loadAnnouncements();
        loadWithdrawals();
        loadUsersAndBalances();
    }
    
    document.getElementById('sendAnnouncementBtn').addEventListener('click', sendAnnouncement);

    function sendAnnouncement() {
        const textArea = document.getElementById('announcement-textarea');
        const text = textArea.value.trim();
        const user = auth.currentUser;
        if (!text) return alert("Elan mətni boş ola bilməz.");
        if (!user) return alert("Elan göndərmək üçün daxil olmalısınız.");
        const announcementData = { text, senderName: user.displayName, createdAt: firebase.database.ServerValue.TIMESTAMP };
        db.ref('announcements').push(announcementData).then(() => { alert("Elan uğurla göndərildi."); textArea.value = ''; }).catch(error => alert("Xəta: " + error.message));
    }

    function loadAnnouncements() {
        const listContainer = document.getElementById('past-announcements-list');
        db.ref('announcements').orderByChild('createdAt').limitToLast(10).on('value', snapshot => {
            listContainer.innerHTML = '';
            if(!snapshot.exists()) { listContainer.innerHTML = '<p class="no-data">Hələ heç bir elan göndərilməyib.</p>'; return; }
            let announcements = [];
            snapshot.forEach(child => announcements.push({key: child.key, ...child.val()}));
            announcements.reverse().forEach(ann => {
                const item = document.createElement('div');
                item.className = 'past-announcement-item';
                item.innerHTML = `<div><p>${ann.text}</p><div class="meta">${ann.senderName} - ${new Date(ann.createdAt).toLocaleString()}</div></div><button class="btn btn-dark-red" onclick="deleteAnnouncement('${ann.key}')">Sil</button>`;
                listContainer.appendChild(item);
            });
        });
    }
    
    function deleteAnnouncement(key) { if(confirm("Bu elanı silmək istədiyinizə əminsiniz?")) db.ref('announcements/' + key).remove(); }

    function loadDashboardStats() {
        db.ref('users').on('value', s => document.getElementById('stat-total-users').textContent = s.exists() ? s.numChildren() : 0);
        db.ref('balances').on('value', s => { let t = 0; if (s.exists()) s.forEach(c => t += c.val().amount || 0); document.getElementById('stat-total-balance').textContent = t.toFixed(2); });
        db.ref('withdrawals').on('value', s => { let c = 0, a = 0; if (s.exists()) s.forEach(ch => { const r = ch.val(); if (r.status === 'pending' && !r.isArchived) { c++; a += r.requestData.amount || 0; } }); document.getElementById('stat-pending-reqs').textContent = c; document.getElementById('stat-pending-amount').textContent = a.toFixed(2); });
        db.ref('support_chats').on('value', s => { let u = 0; if (s.exists()) s.forEach(c => { if (c.val().new_message_for_admin) u++; }); document.getElementById('stat-unread-msgs').textContent = u; });
    }
    
    function addBalanceAndCreateHistory(userId, amountToAdd) { const a = parseFloat(amountToAdd); if (!userId || isNaN(a) || a <= 0) return Promise.reject(new Error("Düzgün məbləğ daxil edilməyib.")); const k = db.ref('deposits').push().key; const u = {}; u[`/deposits/${k}`] = { uid: userId, amount: a, createdAt: firebase.database.ServerValue.TIMESTAMP }; u[`/balances/${userId}/amount`] = firebase.database.ServerValue.increment(a); return db.ref().update(u); }
    async function updateRequestStatus(key, newStatus) { if (!confirm(`Bu sorğunu "${newStatus === 'approved' ? 'Onayla' : 'Rədd et'}" statusuna dəyişmək istəyirsiniz?`)) return; if (newStatus === 'approved') { db.ref(`withdrawals/${key}`).update({ status: newStatus }).then(() => alert("Sorğu təsdiqləndi.")).catch(e => alert("Xəta: " + e.message)); } else if (newStatus === 'rejected') { const ref = db.ref(`withdrawals/${key}`); try { const s = await ref.once('value'); const d = s.val(); if (!d || d.status !== 'pending') { alert("Sorğu artıq emal edilib."); return ref.update({ status: newStatus }); } await db.ref(`balances/${d.uid}/amount`).set(firebase.database.ServerValue.increment(d.requestData.amount)); await ref.update({ status: newStatus }); alert(`Sorğu rədd edildi və məbləğ istifadəçiyə geri qaytarıldı.`); } catch (e) { alert("Xəta: " + e.message); } } }
    
    function closeUserDetailsModal() { document.getElementById('userDetailsModal').style.display = 'none'; if (modalMessagesListener) modalMessagesListener.off(); }
    async function openUserDetails(uid) {
        const modal = document.getElementById('userDetailsModal');
        modal.style.display = 'flex';
        document.getElementById('modalUserName').textContent = 'Yüklənir...';
        document.getElementById('modal-transactions-list').innerHTML = '<p class="no-data">Yüklənir...</p>';
        document.getElementById('modal-messages').innerHTML = '';
        try {
            const [userSnap, balanceSnap, depositsSnap, withdrawalsSnap, chatRefSnap] = await Promise.all([
                db.ref(`users/${uid}`).once('value'),
                db.ref(`balances/${uid}`).once('value'),
                db.ref('deposits').orderByChild('uid').equalTo(uid).once('value'),
                db.ref('withdrawals').orderByChild('uid').equalTo(uid).once('value'),
                db.ref(`support_chats/${uid}`).once('value')
            ]);
            const userData = userSnap.val() || {};
            const balanceData = balanceSnap.val() || { amount: 0 };
            document.getElementById('modalUserName').textContent = userData.displayName || 'Adsız';
            document.getElementById('modalUserEmail').textContent = userData.email || 'Naməlum';
            document.getElementById('modalUserUID').textContent = uid;
            document.getElementById('modalUserBalance').textContent = `${parseFloat(balanceData.amount).toFixed(2)} AZN`;
            const userStatusSpan = document.getElementById('modalUserStatus'), suspendBtn = document.getElementById('modal-suspend-btn'), reactivateBtn = document.getElementById('modal-reactivate-btn');
            if(userData.isSuspended) { userStatusSpan.textContent = "Dondurulub"; userStatusSpan.style.color = 'var(--red)'; suspendBtn.style.display = 'none'; reactivateBtn.style.display = 'block'; }
            else { userStatusSpan.textContent = "Aktiv"; userStatusSpan.style.color = 'var(--green)'; suspendBtn.style.display = 'block'; reactivateBtn.style.display = 'none'; }
            suspendBtn.onclick = () => suspendUser(uid, true);
            reactivateBtn.onclick = () => suspendUser(uid, false);
            document.getElementById('modal-apply-balance-btn').onclick = () => applyBalanceChange(uid, 'modal-balance-input');
            let allTransactions = [];
            if(depositsSnap.exists()) depositsSnap.forEach(c => allTransactions.push({ ...c.val(), type: 'deposit', key: c.key }));
            if(withdrawalsSnap.exists()) withdrawalsSnap.forEach(c => allTransactions.push({ ...c.val(), type: 'withdrawal', key: c.key }));
            allTransactions.sort((a,b) => b.createdAt - a.createdAt);
            const transactionsList = document.getElementById('modal-transactions-list');
            transactionsList.innerHTML = '';
            if (allTransactions.length > 0) allTransactions.forEach(t => { const i = document.createElement('div'); i.className = 'past-announcement-item'; if(t.type === 'deposit') i.innerHTML = `<p><b>+${t.amount.toFixed(2)} AZN</b> - Mədaxil</p><div class="meta">${new Date(t.createdAt).toLocaleString()}</div>`; else i.innerHTML = `<p><b>-${t.requestData.amount.toFixed(2)} AZN</b> - Çıxarış (${t.status})</p><div class="meta">${new Date(t.createdAt).toLocaleString()}</div>`; transactionsList.appendChild(i); });
            else transactionsList.innerHTML = '<p class="no-data">Əməliyyat tapılmadı.</p>';
            const messagesContainer = document.getElementById('modal-messages');
            messagesContainer.innerHTML = '';
            if(chatRefSnap.exists() && chatRefSnap.val().messages) {
                Object.values(chatRefSnap.val().messages).forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message ${msg.sender === 'admin' ? 'admin' : 'user'}`;
                    msgDiv.textContent = msg.text;
                    messagesContainer.appendChild(msgDiv);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else messagesContainer.innerHTML = '<p class="no-data">Yazışma tapılmadı.</p>';
            document.getElementById('modal-send-reply-btn').onclick = () => sendAdminReply(uid, 'modal-reply-input');
        } catch (error) { console.error("Xəta:", error); alert("Xəta baş verdi."); }
    }
    
    function suspendUser(uid, isSuspending) {
        const actionText = isSuspending ? "dondurmaq" : "aktivləşdirmək";
        if (!confirm(`Bu istifadəçinin hesabını ${actionText} istədiyinizə əminsiniz?`)) return;
        db.ref(`users/${uid}`).update({ isSuspended }).then(() => { alert(`Hesab uğurla ${actionText} edildi.`); openUserDetails(uid); }).catch(e => alert("Xəta: " + e.message));
    }
    
    function displayUsers(userList) {
        const userTableBody = document.getElementById('userTable').querySelector('tbody');
        userTableBody.innerHTML = '';
        if (userList.length === 0) { userTableBody.innerHTML = '<tr class="no-data-row"><td colspan="4" class="no-data">İstifadəçi tapılmadı.</td></tr>'; return; }
        userList.forEach(userData => {
            const tr = document.createElement('tr');
            tr.className = 'clickable';
            tr.onclick = () => openUserDetails(userData.uid);
            let statusHtml = `<span style="color: var(--green)">Aktiv</span>`;
            if (userData.isSuspended) statusHtml = `<span style="color: var(--red)">Dondurulub</span>`;
            tr.innerHTML = `<td data-label="Ad">${userData.displayName||'Adsız'}</td><td data-label="Email">${userData.email}</td><td data-label="Balans (AZN)"><b>${parseFloat(userData.balance).toFixed(2)} AZN</b></td><td data-label="Status">${statusHtml}</td>`;
            userTableBody.appendChild(tr);
        });
    }

    function loadUsersAndBalances() {
        db.ref('users').on('value', userSnapshot => {
            db.ref('balances').on('value', balanceSnapshot => {
                masterUserList = [];
                if (userSnapshot.exists()) {
                    const allBalances = balanceSnapshot.val() || {};
                    userSnapshot.forEach(childSnapshot => {
                        const uid = childSnapshot.key;
                        const userData = childSnapshot.val();
                        masterUserList.push({ uid, ...userData, balance: allBalances[uid]?.amount || 0 });
                    });
                }
                document.getElementById('userSearchInput').dispatchEvent(new Event('input'));
            });
        });
    }

    document.getElementById('userSearchInput').addEventListener('input', e => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredList = searchTerm ? masterUserList.filter(u => (u.displayName||'').toLowerCase().includes(searchTerm) || (u.email||'').toLowerCase().includes(searchTerm)) : masterUserList;
        displayUsers(filteredList);
    });

    document.querySelector('.tabs').addEventListener('click', e => {
        if(e.target.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById('tab-content-' + e.target.dataset.tab).classList.add('active');
        }
    });

    async function applyBalanceChange(uid, inputId) {
        const inputElement = document.getElementById(inputId);
        const inputValue = inputElement.value.trim().replace(',', '.');
        if (inputValue === '') return alert("Zəhmət olmasa, bir dəyər daxil edin.");
        const changeValue = parseFloat(inputValue);
        if (isNaN(changeValue)) return alert("Zəhmət olmasa, düzgün rəqəm daxil edin.");
        try {
            const balanceSnapshot = await db.ref(`balances/${uid}`).once('value');
            const currentBalance = balanceSnapshot.exists() ? parseFloat(balanceSnapshot.val().amount) : 0;
            let amountAdded = 0, finalBalance = 0;
            if (inputValue.startsWith('+')) { amountAdded = changeValue; finalBalance = currentBalance + amountAdded; }
            else if (inputValue.startsWith('-')) { finalBalance = currentBalance + changeValue; if (finalBalance < 0) finalBalance = 0; if (confirm(`Balansı ${finalBalance.toFixed(2)} AZN etmək istəyirsiniz?`)) { await db.ref(`balances/${uid}`).set({ amount: finalBalance }); alert("Balans yeniləndi!"); inputElement.value = ''; openUserDetails(uid); } return; }
            else { finalBalance = changeValue; amountAdded = finalBalance - currentBalance; }
            if (amountAdded > 0) { if (confirm(`Balansa ${amountAdded.toFixed(2)} AZN əlavə edilsin? (Yeni balans: ${finalBalance.toFixed(2)} AZN)`)) { await addBalanceAndCreateHistory(uid, amountAdded); alert("Balans artırıldı və tarixçəyə yazıldı!"); inputElement.value = ''; openUserDetails(uid); } }
            else { if (confirm(`Balansı ${finalBalance.toFixed(2)} AZN etmək istəyirsiniz?`)) { await db.ref(`balances/${uid}`).set({ amount: finalBalance }); alert("Balans yeniləndi!"); inputElement.value = ''; openUserDetails(uid); } }
        } catch (error) { alert("Xəta: " + error.message); }
    }
    
    function sendAdminReply(uid, inputId) { const input = document.getElementById(inputId); const text = input.value.trim(); if (text === '' || !uid) return; const msgData = { text, sender: 'admin', timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`support_chats/${uid}/messages`).push(msgData); db.ref(`support_chats/${uid}`).update({ last_message: text, last_updated: firebase.database.ServerValue.TIMESTAMP, new_message_for_admin: false, new_message_for_user_count: firebase.database.ServerValue.increment(1) }); input.value = ''; setTimeout(() => openUserDetails(uid), 300); }
    function loadWithdrawals() { const t = document.getElementById('withdrawalsTable').querySelector('tbody'); db.ref('withdrawals').on('value', s => { if (!s.exists()) { t.innerHTML = '<tr class="no-data-row"><td colspan="7">Heç bir sorğu yoxdur.</td></tr>'; return; } t.innerHTML = ''; let r = []; s.forEach(c => r.push({ key: c.key, ...c.val() })); const v = r.filter(req => !req.isArchived); v.sort((a, b) => { const ap = a.status === 'pending', bp = b.status === 'pending'; if (ap && !bp) return -1; if (!ap && bp) return 1; return b.createdAt - a.createdAt; }); if (v.length === 0) { t.innerHTML = '<tr class="no-data-row"><td colspan="7">Aktiv sorğu yoxdur.</td></tr>'; return; } v.forEach(d => { const rd = d.requestData; const tr = document.createElement('tr'); let st, sc; switch (d.status) { case 'approved': st = 'Onaylandı'; sc = 'status-approved'; break; case 'rejected': st = 'Rədd edildi'; sc = 'status-rejected'; break; default: st = 'Gözləmədə'; sc = 'status-pending'; } let ab; if (d.status === 'pending') ab = `<button class="btn btn-green" onclick="updateRequestStatus('${d.key}','approved')">Onayla</button><button class="btn btn-red" onclick="updateRequestStatus('${d.key}','rejected')">Rədd et</button>`; else ab = `<button class="btn btn-dark-red" onclick="archiveRequest('${d.key}')">Arxivlə</button>`; tr.innerHTML = `<td data-label="Email">${d.userEmail}</td><td data-label="Ad/Soyad">${rd.name} ${rd.surname}</td><td data-label="Kart">${rd.cardNumber}</td><td data-label="Məbləğ"><b>${parseFloat(rd.amount).toFixed(2)} AZN</b></td><td data-label="Tarix">${new Date(d.createdAt).toLocaleString()}</td><td data-label="Status"><span class="status ${sc}">${st}</span></td><td data-label="Əməliyyat"><div class="actions-cell">${ab}</div></td>`; t.appendChild(tr); }); }); }
    function archiveRequest(key) { if (confirm("Bu sorğunu arxivləşdirmək istəyirsiniz?")) db.ref(`withdrawals/${key}`).update({ isArchived: true }).then(() => alert("Sorğu arxivləndi.")).catch(e => alert("Xəta: " + e.message)); }
</script>
</body>
</html>
