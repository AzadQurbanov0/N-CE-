<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCI | Ultra Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --dark: #0f172a;
            --light: #f8fafc; --white: #ffffff; --border: #e2e8f0;
        }

        body { font-family: 'Inter', sans-serif; background: var(--light); margin: 0; color: var(--dark); }
        .header { background: var(--white); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 24px; font-weight: 900; letter-spacing: 2px; }
        .logo span { color: var(--primary); font-size: 14px; font-weight: 400; }

        .wrapper { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 16px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } }

        .card { background: var(--white); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 25px; }
        .card-header { padding: 15px 25px; border-bottom: 1px solid var(--border); background: #fafafa; display: flex; justify-content: space-between; align-items: center; }
        
        /* Filters */
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 8px 15px; border-radius: 8px; background: #e2e8f0; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap; }
        .tab.active { background: var(--dark); color: white; }

        /* Forms */
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--dark); color: white; width: 100%; justify-content: center; }
        .btn-excel { background: #166534; color: white; font-size: 12px; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Order Box */
        .order-box { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; }
        .order-top { padding: 12px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .order-content { padding: 15px; }
        .product-mini-list { display: flex; gap: 5px; margin-top: 10px; }
        .mini-img { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">INCI <span>PRO ADMIN</span></div>
    <div style="display: flex; gap: 15px; align-items: center;">
        <button class="btn btn-excel" onclick="exportOrders()"><i class="fas fa-file-excel"></i> Excel-ə Çıxar</button>
        <div id="liveClock" style="font-weight: 700; color: var(--primary);">00:00:00</div>
    </div>
</div>

<div class="wrapper">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #eff6ff; color: var(--primary);"><i class="fas fa-shopping-cart"></i></div>
            <div><small>Sifariş</small><div id="totalOrders">0</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #f0fdf4; color: var(--success);"><i class="fas fa-money-bill-wave"></i></div>
            <div><small>Gəlir</small><div id="totalRevenue" style="font-weight: 800;">0 AZN</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fef2f2; color: var(--danger);"><i class="fas fa-box"></i></div>
            <div><small>Stok</small><div id="totalProducts">0</div></div>
        </div>
    </div>

    <div class="main-grid">
        <div class="side">
            <div class="card">
                <div class="card-header"><h3 id="formTitle">Yeni Məhsul</h3></div>
                <div class="card-body" style="padding: 20px;">
                    <input type="hidden" id="editKey">
                    <input id="pName" placeholder="Məhsulun adı">
                    <div style="display:flex; gap:10px;">
                        <input id="pPrice" type="number" placeholder="Qiymət">
                        <select id="pCat">
                            <option value="Geyim">Geyim</option>
                            <option value="Ayaqqabı">Ayaqqabı</option>
                            <option value="Aksesuar">Aksesuar</option>
                        </select>
                    </div>
                    <input id="pSizes" placeholder="Ölçülər (S, M, L)">
                    <input id="pImg" placeholder="Şəkil URL">
                    <textarea id="pDesc" rows="2" placeholder="Təsvir"></textarea>
                    
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        <label class="switch">
                            <input type="checkbox" id="pInStock" checked>
                            <span class="slider"></span>
                        </label>
                        <span>Stokda Var</span>
                    </div>

                    <button class="btn btn-primary" id="saveBtn" onclick="saveProduct()">Yadda Saxla</button>
                    <button class="btn" id="cancelBtn" style="display:none; width:100%; margin-top:5px;" onclick="resetForm()">Ləğv Et</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Stok Siyahısı</h3>
                    <input type="text" id="pSearch" placeholder="Axtar..." onkeyup="searchProduct()" style="width:100px; margin:0;">
                </div>
                <div id="pListAdmin" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="side">
            <div class="filter-tabs" id="filterTabs">
                <div class="tab active" onclick="filterOrders('Hamısı', this)">Hamısı</div>
                <div class="tab" onclick="filterOrders('Sifariş verildi', this)">Yeni</div>
                <div class="tab" onclick="filterOrders('Yola düşüb', this)">Yolda</div>
                <div class="tab" onclick="filterOrders('Təhvil verildi', this)">Tamamlanmış</div>
            </div>
            <div id="orderListAdmin"></div>
        </div>
    </div>
</div>

<audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    firebase.initializeApp({ databaseURL: "https://azad042-65afa-default-rtdb.firebaseio.com" });
    const db = firebase.database();
    let currentFilter = "Hamısı";
    let firstLoad = true;

    setInterval(() => { document.getElementById("liveClock").innerText = new Date().toLocaleTimeString(); }, 1000);

    // Məhsulu Yadda Saxla və ya Yenilə
    function saveProduct() {
        const key = document.getElementById("editKey").value;
        const data = {
            name: document.getElementById("pName").value,
            price: parseFloat(document.getElementById("pPrice").value),
            img: document.getElementById("pImg").value,
            description: document.getElementById("pDesc").value,
            category: document.getElementById("pCat").value,
            sizes: document.getElementById("pSizes").value,
            inStock: document.getElementById("pInStock").checked
        };

        if(!data.name || !data.price) return alert("Zəhmət olmasa məhsulun adını və qiymətini qeyd edin!");

        if(key) {
            // Əgər key varsa, mövcud məhsulu yeniləyirik
            db.ref('products/' + key).update(data).then(() => { 
                alert("Məhsul uğurla yeniləndi!"); 
                resetForm(); 
            });
        } else {
            // Əgər key yoxdursa, yeni məhsul əlavə edirik
            db.ref('products').push(data).then(() => { 
                alert("Məhsul uğurla əlavə edildi!"); 
                resetForm(); 
            });
        }
    }

    // Redaktə rejiminə keçid
    function editProduct(key, name, price, img, desc, cat, sizes, inStock) {
        document.getElementById("editKey").value = key;
        document.getElementById("pName").value = name;
        document.getElementById("pPrice").value = price;
        document.getElementById("pImg").value = img;
        document.getElementById("pDesc").value = desc;
        document.getElementById("pCat").value = cat;
        document.getElementById("pSizes").value = sizes || "";
        document.getElementById("pInStock").checked = (inStock !== false);
        
        document.getElementById("formTitle").innerText = "Məhsulu Redaktə Et";
        document.getElementById("saveBtn").innerText = "Yenilə";
        document.getElementById("cancelBtn").style.display = "block";
        window.scrollTo(0, 0); // Formun görünməsi üçün yuxarı sürüşdürür
    }

    // Formu sıfırla
    function resetForm() {
        ["editKey", "pName", "pPrice", "pImg", "pDesc", "pSizes"].forEach(id => document.getElementById(id).value = "");
        document.getElementById("pInStock").checked = true;
        document.getElementById("formTitle").innerText = "Yeni Məhsul";
        document.getElementById("saveBtn").innerText = "Yadda Saxla";
        document.getElementById("cancelBtn").style.display = "none";
    }

    // Məhsulu Sil
    function deleteProduct(id) { 
        if(confirm('Bu məhsulu silmək istədiyinizə əminsiniz?')) {
            db.ref('products/'+id).remove().then(() => {
                alert("Məhsul silindi!");
            });
        } 
    }

    // Stok Siyahısını Göstər
    db.ref('products').on('value', snap => {
        let html = "", count = 0;
        snap.forEach(c => {
            let p = c.val(); count++;
            let statusBadge = p.inStock ? '<span style="color:green; font-size:10px;">[Aktiv]</span>' : '<span style="color:red; font-size:10px;">[Bağlı]</span>';
            // HTML dırnaq işarələri ilə bağlı xətaları önləmək üçün escape tətbiq olunur
            let pDescEscaped = (p.description || "").replace(/'/g, "\\'");
            let pNameEscaped = (p.name || "").replace(/'/g, "\\'");
            
            html += `
            <div class="p-item" data-name="${p.name}" style="display:flex; align-items:center; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="${p.img}" style="width:30px; height:30px; border-radius:5px; object-fit:cover;">
                    <div>
                        <div style="font-size:12px; font-weight:600;">${p.name} ${statusBadge}</div>
                        <div style="font-size:10px; color:gray;">Qiymət: ${p.price} AZN | Ölçülər: ${p.sizes || 'Yoxdur'}</div>
                    </div>
                </div>
                <div>
                    <button onclick="editProduct('${c.key}','${pNameEscaped}',${p.price},'${p.img}','${pDescEscaped}','${p.category}','${p.sizes || ''}', ${p.inStock})" style="border:none; color:var(--primary); cursor:pointer; background:none; font-size:16px;"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteProduct('${c.key}')" style="border:none; color:var(--danger); cursor:pointer; background:none; font-size:16px; margin-left:10px;"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        });
        document.getElementById("pListAdmin").innerHTML = html;
        document.getElementById("totalProducts").innerText = count;
    });

    // Sifarişləri İdarə Et
    db.ref('orders').on('value', snap => {
        if (!firstLoad) document.getElementById("orderSound").play();
        firstLoad = false;
        renderOrders(snap);
    });

    function renderOrders(snap) {
        let html = "", count = 0, revenue = 0;
        snap.forEach(c => {
            let o = c.val();
            let price = parseFloat(o.total) || 0;
            revenue += price;
            count++;
            if(currentFilter !== "Hamısı" && o.status !== currentFilter) return;

            html = `
            <div class="order-box">
                <div class="order-top">
                    <span>#${o.id} - <b>${o.customer}</b></span>
                    <span style="color:var(--primary); font-weight:700;">${o.status}</span>
                </div>
                <div class="order-content">
                    <small>${o.address} | ${o.phone}</small>
                    <div style="margin: 5px 0; font-size: 12px; color: #555;">Sifariş: <b>${o.selectedSize || 'Ölçü seçilməyib'}</b></div>
                    <div class="product-mini-list">${(o.itemImages || []).map(i => `<img src="${i}" class="mini-img">`).join('')}</div>
                    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <b>${o.total}</b>
                        <select onchange="updateStatus('${c.key}', this.value)" style="width:120px; margin:0; font-size:11px;">
                            <option value="Sifariş verildi" ${o.status=='Sifariş verildi'?'selected':''}>Yeni</option>
                            <option value="Yola düşüb" ${o.status=='Yola düşüb'?'selected':''}>Yolda</option>
                            <option value="Təhvil verildi" ${o.status=='Təhvil verildi'?'selected':''}>Tamamlandı</option>
                        </select>
                    </div>
                </div>
            </div>` + html;
        });
        document.getElementById("orderListAdmin").innerHTML = html || "<p style='text-align:center;'>Sifariş yoxdur.</p>";
        document.getElementById("totalOrders").innerText = count;
        document.getElementById("totalRevenue").innerText = revenue.toFixed(2) + " AZN";
    }

    function filterOrders(status, el) {
        currentFilter = status;
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        el.classList.add("active");
        db.ref('orders').once('value', renderOrders);
    }

    function updateStatus(key, val) { db.ref('orders/'+key).update({status: val}); }

    function exportOrders() {
        db.ref('orders').once('value', snap => {
            let data = [];
            snap.forEach(c => {
                let o = c.val();
                data.push({ ID: o.id, Müştəri: o.customer, Telefon: o.phone, Ünvan: o.address, Seçilmiş_Ölçü: o.selectedSize, Məbləğ: o.total, Status: o.status, Tarix: o.orderTime });
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sifarişlər");
            XLSX.writeFile(wb, "Inci_Sifarisler.xlsx");
        });
    }

    function searchProduct() {
        let val = document.getElementById("pSearch").value.toLowerCase();
        document.querySelectorAll(".p-item").forEach(item => {
            item.style.display = item.getAttribute("data-name").toLowerCase().includes(val) ? "flex" : "none";
        });
    }
</script>
</body>
</html>
