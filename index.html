<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCI | Ultra Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --dark: #0f172a;
            --light: #f8fafc; --white: #ffffff; --border: #e2e8f0;
        }

        body { font-family: 'Inter', sans-serif; background: var(--light); margin: 0; color: var(--dark); }
        
        /* Header */
        .header { background: var(--white); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 24px; font-weight: 900; letter-spacing: 2px; }
        .logo span { color: var(--primary); font-size: 14px; font-weight: 400; }

        .wrapper { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 16px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* Main Layout */
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: var(--white); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card-header { padding: 15px 25px; border-bottom: 1px solid var(--border); background: #fafafa; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { margin: 0; font-size: 16px; font-weight: 800; }

        /* Tabs */
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .tab { padding: 10px 20px; border-radius: 12px; background: var(--white); border: 1px solid var(--border); cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap; transition: 0.2s; }
        .tab.active { background: var(--dark); color: white; border-color: var(--dark); }

        /* Form Elements */
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-primary { background: var(--dark); color: white; width: 100%; justify-content: center; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-excel { background: #166534; color: white; }

        /* Order Box Design */
        .order-box { background: var(--white); border: 1px solid var(--border); border-radius: 18px; margin-bottom: 15px; transition: 0.3s; position: relative; }
        .order-box:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .order-top { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid var(--border); border-radius: 18px 18px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .order-content { padding: 20px; }
        
        /* Badges */
        .status-badge { padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .status-new { background: #e0f2fe; color: #0369a1; }
        .status-cancel { background: #fee2e2; color: #b91c1c; }
        .status-done { background: #dcfce7; color: #166534; }

        .delete-btn { color: var(--danger); border: none; background: #fff1f2; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .product-mini-list { display: flex; gap: 8px; margin: 15px 0; }
        .mini-img { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; border: 1px solid var(--border); }
        
        .reason-box { background: #fff1f2; color: #b91c1c; padding: 10px; border-radius: 8px; font-size: 12px; margin-top: 10px; border-left: 4px solid var(--danger); }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">INCI <span>PRO ADMIN</span></div>
    <div style="display: flex; gap: 15px; align-items: center;">
        <button class="btn btn-excel" onclick="exportOrders()"><i class="fas fa-file-excel"></i> Excel-ə Çıxar</button>
        <div id="liveClock" style="font-weight: 700; color: var(--primary); background: #eff6ff; padding: 8px 15px; border-radius: 10px;">00:00:00</div>
    </div>
</div>

<div class="wrapper">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #eff6ff; color: var(--primary);"><i class="fas fa-shopping-cart"></i></div>
            <div><small style="color:var(--secondary)">Ümumi Sifariş</small><div id="totalOrders" style="font-weight: 800; font-size: 18px;">0</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #f0fdf4; color: var(--success);"><i class="fas fa-money-bill-wave"></i></div>
            <div><small style="color:var(--secondary)">Ümumi Gəlir</small><div id="totalRevenue" style="font-weight: 800; font-size: 18px;">0 AZN</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff7ed; color: var(--warning);"><i class="fas fa-box"></i></div>
            <div><small style="color:var(--secondary)">Məhsul Sayı</small><div id="totalProducts" style="font-weight: 800; font-size: 18px;">0</div></div>
        </div>
    </div>

    <div class="main-grid">
        <div class="side">
            <div class="card">
                <div class="card-header"><h3 id="formTitle">Məhsul İdarəetməsi</h3></div>
                <div style="padding: 20px;">
                    <input type="hidden" id="editKey">
                    <input id="pName" placeholder="Məhsul adı">
                    <input id="pPrice" type="number" placeholder="Qiymət (AZN)">
                    <input id="pSizes" placeholder="Ölçülər (S, M, L)">
                    <input id="pImg" placeholder="Şəkil URL">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveProduct()">Yadda Saxla</button>
                    <button class="btn" id="cancelBtn" style="display:none; width:100%; margin-top:8px; background:#e2e8f0;" onclick="resetForm()">Ləğv Et</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h3>Stok Listi</h3></div>
                <div id="pListAdmin" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="side">
            <div class="filter-tabs" id="filterTabs">
                <div class="tab active" onclick="filterOrders('Hamısı', this)">Hamısı</div>
                <div class="tab" onclick="filterOrders('Sifariş verildi', this)">Yeni</div>
                <div class="tab" onclick="filterOrders('Təhvil verildi', this)">Tarixçə</div>
                <div class="tab" onclick="filterOrders('Ləğv edildi', this)">Ləğv Olunanlar</div>
            </div>
            <div id="orderListAdmin"></div>
        </div>
    </div>
</div>

<audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    firebase.initializeApp({ databaseURL: "https://azad042-65afa-default-rtdb.firebaseio.com" });
    const db = firebase.database();
    let currentFilter = "Hamısı";
    let firstLoad = true;

    setInterval(() => { document.getElementById("liveClock").innerText = new Date().toLocaleTimeString(); }, 1000);

    // Məhsul Yadda Saxla
    function saveProduct() {
        const key = document.getElementById("editKey").value;
        const data = {
            name: document.getElementById("pName").value,
            price: parseFloat(document.getElementById("pPrice").value),
            sizes: document.getElementById("pSizes").value,
            img: document.getElementById("pImg").value,
            inStock: true
        };
        if(!data.name || !data.price) return alert("Ad və qiymət mütləqdir!");
        
        if(key) {
            db.ref('products/'+key).update(data).then(() => { alert("Yeniləndi!"); resetForm(); });
        } else {
            db.ref('products').push(data).then(() => { alert("Əlavə edildi!"); resetForm(); });
        }
    }

    function resetForm() {
        ["editKey", "pName", "pPrice", "pImg", "pSizes"].forEach(id => document.getElementById(id).value = "");
        document.getElementById("formTitle").innerText = "Məhsul İdarəetməsi";
        document.getElementById("saveBtn").innerText = "Yadda Saxla";
        document.getElementById("cancelBtn").style.display = "none";
    }

    // Sifarişləri Render Et
    db.ref('orders').on('value', snap => {
        if (!firstLoad) document.getElementById("orderSound").play();
        firstLoad = false;
        renderOrders(snap);
    });

    function renderOrders(snap) {
        let html = "", count = 0, revenue = 0;
        snap.forEach(c => {
            let o = c.val();
            let rawTotal = parseFloat(o.total) || 0;
            count++; revenue += rawTotal;

            if(currentFilter !== "Hamısı" && o.status !== currentFilter) return;

            let sClass = "status-new";
            if(o.status === "Təhvil verildi") sClass = "status-done";
            if(o.status === "Ləğv edildi") sClass = "status-cancel";

            html = `
            <div class="order-box">
                <div class="order-top">
                    <span style="font-weight:800;">#${o.id} - ${o.customer}</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span class="status-badge ${sClass}">${o.status}</span>
                        ${(o.status === "Təhvil verildi" || o.status === "Ləğv edildi") ? 
                          `<button class="delete-btn" onclick="deleteOrder('${c.key}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>
                <div class="order-content">
                    <div style="font-size:13px; color:var(--secondary); line-height:1.6;">
                        <i class="fas fa-phone"></i> ${o.phone} | <i class="fas fa-map-marker-alt"></i> ${o.address}<br>
                        <i class="fas fa-tag"></i> Seçilmiş Ölçü: <b style="color:var(--primary)">${o.selectedSize || 'Yox'}</b>
                    </div>
                    
                    <div class="product-mini-list">
                        ${(o.itemImages || []).map(img => `<img src="${img}" class="mini-img">`).join('')}
                    </div>

                    ${o.cancelReason ? `<div class="reason-box"><b>Ləğv Səbəbi:</b> ${o.cancelReason}</div>` : ''}

                    <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; pt:15px;">
                        <span style="font-size:18px; font-weight:900; color:var(--dark);">${o.total}</span>
                        <select onchange="updateStatus('${c.key}', this.value)" style="width:160px; margin:0;">
                            <option value="Sifariş verildi" ${o.status=='Sifariş verildi'?'selected':''}>Yeni Sifariş</option>
                            <option value="Hazırlanır" ${o.status=='Hazırlanır'?'selected':''}>Hazırlanır</option>
                            <option value="Kuryerdə" ${o.status=='Kuryerdə'?'selected':''}>Kuryerdə</option>
                            <option value="Yolda" ${o.status=='Yolda'?'selected':''}>Yolda</option>
                            <option value="Çatdı" ${o.status=='Çatdı'?'selected':''}>Çatdı</option>
                            <option value="Təhvil verildi" ${o.status=='Təhvil verildi'?'selected':''}>✓ Tamamla (Tarixçə)</option>
                            <option value="Ləğv edildi" ${o.status=='Ləğv edildi'?'selected':''}>✕ Ləğv Et</option>
                        </select>
                    </div>
                </div>
            </div>` + html;
        });
        document.getElementById("orderListAdmin").innerHTML = html || "<p style='text-align:center; padding:40px; color:gray;'>Sifariş tapılmadı.</p>";
        document.getElementById("totalOrders").innerText = count;
        document.getElementById("totalRevenue").innerText = revenue.toFixed(2) + " AZN";
    }

    function updateStatus(key, val) {
        if(val === "Ləğv edildi") {
            const reason = prompt("Ləğv edilmə səbəbini daxil edin (müştəri bunu görəcək):");
            if(reason) db.ref('orders/'+key).update({status: val, cancelReason: reason});
        } else {
            db.ref('orders/'+key).update({status: val, cancelReason: null});
        }
    }

    function deleteOrder(key) { if(confirm("Bu sifarişi bazadan silmək istəyirsiniz?")) db.ref('orders/'+key).remove(); }

    function filterOrders(s, el) {
        currentFilter = s;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        db.ref('orders').once('value', renderOrders);
    }

    // Stokdakı məhsullar siyahısı
    db.ref('products').on('value', snap => {
        let html = "", count = 0;
        snap.forEach(c => {
            let p = c.val(); count++;
            html += `
            <div style="display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid #eee;">
                <img src="${p.img}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                <div style="flex:1;">
                    <div style="font-size:13px; font-weight:700;">${p.name}</div>
                    <div style="font-size:11px; color:gray;">${p.price} AZN | ${p.sizes || '-'}</div>
                </div>
                <button onclick="editProduct('${c.key}','${p.name}',${p.price},'${p.img}','','','${p.sizes}')" style="border:none; background:none; color:var(--primary); cursor:pointer;"><i class="fas fa-edit"></i></button>
            </div>`;
        });
        document.getElementById("pListAdmin").innerHTML = html;
        document.getElementById("totalProducts").innerText = count;
    });

    function exportOrders() {
        db.ref('orders').once('value', snap => {
            let data = [];
            snap.forEach(c => {
                let o = c.val();
                data.push({ ID: o.id, Müştəri: o.customer, Telefon: o.phone, Ünvan: o.address, Məbləğ: o.total, Status: o.status });
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sifarişlər");
            XLSX.writeFile(wb, "Inci_Sifarisler.xlsx");
        });
    }
</script>
</body>
</html>
